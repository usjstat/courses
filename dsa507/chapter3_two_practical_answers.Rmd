---
title: "Guided Practical: Multiple Testing, FDR, and ANOVA"
author: "Dr. Rajitha M. Silva"
output: html_document
---

## Part 1: Guided Instructions (Choose R or Python)

### Objective:
To understand and implement:
- The effects of multiple testing and how FDR adjustment works
- Tukey's HSD for comparing group means
- Permutation ANOVA in a sports context (Cricket training methods)

### Step-by-Step Instructions

### Section A: Multiple Testing and FDR

#### R Instructions:
1. Simulate 50 p-values using `runif()` between 0 and 0.1.
2. Adjust them using `p.adjust(..., method = "fdr")`.
3. Extract and print those adjusted p-values < 0.05.

#### Python Instructions:
1. Simulate 50 p-values using `np.random.uniform()` between 0 and 0.1.
2. Use `statsmodels.stats.multitest.multipletests()` with method `'fdr_bh'`.
3. Print adjusted p-values that are < 0.05.

---

### Section B: Tukey's Honest Significant Difference (HSD)

#### R Instructions:
1. Simulate 3 groups (A, B, C), each with 10 normal values (means 5, 6, 7).
2. Perform `aov()` and extract MSE and df.
3. Use `qtukey()` to calculate critical value.
4. Calculate HSD.

#### Python Instructions:
1. Simulate 3 groups using `np.random.normal()`.
2. Conduct ANOVA using `scipy.stats.f_oneway()`.
3. Estimate pooled variance (MSE).
4. Use a static value or approximation for the Tukey q-statistic.
5. Compute HSD manually.

---

### Section C: Permutation ANOVA in Sports

#### R Instructions:
1. Create a data frame with four cricket training types: Power, Agility, Endurance, Control (5 each).
2. Generate simulated reaction times with slightly different means.
3. Use `lmPerm::aovp()` with `perm = "Exact"`.
4. Interpret the `Pr(Prob)` output.

#### Python Instructions:
1. Simulate the same cricket training dataset.
2. Calculate observed group mean variance.
3. Define a permutation function to shuffle outcomes.
4. Run the permutation test (e.g., 3000 resamples).
5. Calculate the permutation p-value.

---

## Part 2: Answers / Solution Code

### A. FDR Adjustments

#### R Code:
```{r}
set.seed(123)
p_values <- runif(50, min=0, max=0.1)
adjusted <- p.adjust(p_values, method="fdr")
adjusted[adjusted < 0.05]
```

#### Python Code:
```python
import numpy as np
from statsmodels.stats.multitest import multipletests

np.random.seed(123)
p_values = np.random.uniform(0, 0.1, 50)
adj = multipletests(p_values, method='fdr_bh')[1]
print(adj[adj < 0.05])
```

---

### B. Tukey HSD Calculation

#### R Code:
```{r}
data <- data.frame(
  group = rep(c("A", "B", "C"), each=10),
  value = c(rnorm(10, 5), rnorm(10, 6), rnorm(10, 7))
)
anova_res <- aov(value ~ group, data=data)
sum_res <- summary(anova_res)
MSE <- sum_res[[1]]$`Mean Sq`[2]
df <- sum_res[[1]]$Df[2]
k <- 3; n <- 10
qval <- qtukey(0.95, k, df)
HSD <- qval * sqrt(MSE/n)
HSD
```

#### Python Code:
```python
import scipy.stats as stats
import numpy as np

np.random.seed(0)
a = np.random.normal(5, 1, 10)
b = np.random.normal(6, 1, 10)
c = np.random.normal(7, 1, 10)
all_data = np.concatenate([a, b, c])
MSE = np.var(all_data, ddof=3)
df = len(all_data) - 3
k = 3; n = 10
qval = 3.314  # Approximated q value for df=27, alpha=0.05
HSD = qval * np.sqrt(MSE/n)
HSD
```

---

### C. Permutation ANOVA (Cricket)

#### R Code:
```{r}
library(lmPerm)
set.seed(123)
data <- data.frame(
  TrainingFormat = rep(c("Power", "Agility", "Endurance", "Control"), each=5),
  ReactionTime = c(
    rnorm(5, 0.45, 0.05),
    rnorm(5, 0.43, 0.04),
    rnorm(5, 0.47, 0.06),
    rnorm(5, 0.44, 0.05)
  )
)
summary(aovp(ReactionTime ~ TrainingFormat, data=data, perm="Exact"))
```

#### Python Code:
```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

np.random.seed(123)
formats = ['Power']*5 + ['Agility']*5 + ['Endurance']*5 + ['Control']*5
reaction_times = np.concatenate([
    np.random.normal(0.45, 0.05, 5),
    np.random.normal(0.43, 0.04, 5),
    np.random.normal(0.47, 0.06, 5),
    np.random.normal(0.44, 0.05, 5)
])
data = pd.DataFrame({'Format': formats, 'Time': reaction_times})
obs_var = data.groupby('Format').mean().var().values[0]

def perm_test(df):
    shuffled = df.copy()
    shuffled['Time'] = np.random.permutation(shuffled['Time'])
    return shuffled.groupby('Format').mean().var().values[0]

perm_vars = [perm_test(data) for _ in range(3000)]
p_val = np.mean([v > obs_var for v in perm_vars])
print("Permutation p-value:", p_val)

plt.hist(perm_vars, bins=30, alpha=0.6)
plt.axvline(obs_var, color='red', linestyle='dashed')
plt.title("Permutation Test")
plt.xlabel("Variance")
plt.ylabel("Frequency")
plt.show()
```

---

This practical gives students experience in simulating multiple testing issues, adjusting p-values using FDR, calculating Tukey HSD, and implementing permutation ANOVA with real-world sports examples.
